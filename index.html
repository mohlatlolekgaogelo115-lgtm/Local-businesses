<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AllBusiness - Professional Dashboard</title>
    <style>
        :root {
            --primary: #4a90e2;
            --secondary: #50e3c2;
            --accent: #f5a623;
            --dark: #2c3e50;
            --glass: rgba(255,255,255,0.8);
            --shadow: 0 8px 32px rgba(31,38,135,0.15);
        }

        * { margin:0; padding:0; box-sizing:border-box; font-family:'Segoe UI', sans-serif; }
        body { background:#f0f4f8; color:#222; overflow-x:hidden; }

        header {
            position: fixed; top: 0; width: 100%; z-index: 1000;
            background: var(--glass); backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(255,255,255,0.3);
            box-shadow: var(--shadow);
        }

        .navbar {
            max-width: 1200px; margin: 0 auto; padding: 1rem 2rem;
            display: flex; align-items: center; justify-content: space-between;
        }

        .logo { font-size: 1.5rem; font-weight: 800; color: var(--primary); }

        .search-bar { display: flex; background: white; border-radius: 50px; padding: 5px; border: 1px solid #ddd; }
        .search-bar input { border: none; padding: 0.5rem 1rem; border-radius: 50px; outline: none; }
        .search-bar button { background: var(--primary); color: white; border: none; padding: 0.5rem 1rem; border-radius: 50px; cursor: pointer; }

        section { padding: 8rem 2rem 4rem; max-width: 1200px; margin: 0 auto; }
        .hidden { display: none !important; }

        /* Dashboard Layout */
        .dash-grid { display: grid; grid-template-columns: 1fr 2fr; gap: 2rem; margin-top: 2rem; }
        .stat-card, .info-card, .lead-card { background: white; padding: 2rem; border-radius: 20px; box-shadow: var(--shadow); margin-bottom: 1.5rem; }
        .status-badge { display: inline-block; padding: 4px 12px; border-radius: 20px; font-size: 0.8rem; background: #e8f5e9; color: #2e7d32; }

        /* Leads List */
        .lead-item { padding: 15px; border-bottom: 1px solid #eee; position: relative; }
        .lead-item:last-child { border: none; }
        .lead-item small { color: #999; }

        /* Business Cards */
        #searchResults { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1.5rem; margin-top: 2rem; }
        .biz-card { background: white; padding: 1.5rem; border-radius: 15px; box-shadow: var(--shadow); }

        .modal { 
            position: fixed; inset: 0; background: rgba(0,0,0,0.5); 
            display: none; justify-content: center; align-items: center; z-index: 2000; 
        }
        .modal-content { background: white; padding: 2.5rem; border-radius: 20px; width: 400px; }
        input { width: 100%; padding: 0.8rem; margin: 0.5rem 0; border: 1px solid #ddd; border-radius: 8px; }
        .btn-main { width: 100%; padding: 1rem; background: var(--primary); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; transition: 0.3s; }
        .btn-main:hover { opacity: 0.9; transform: translateY(-2px); }
        
        #logoutBtn { background: #ff4757; color: white; border: none; padding: 0.5rem 1rem; border-radius: 5px; cursor: pointer; }
    </style>
</head>
<body>

    <header>
        <nav class="navbar">
            <div class="logo">AllBusiness</div>
            
            <div id="publicNav" class="search-bar">
                <input type="text" id="searchInput" placeholder="Search category (e.g. gym)...">
                <button onclick="searchBusinesses()">Search</button>
            </div>

            <div class="auth-zone">
                <button id="regBtn" class="btn-main" style="padding: 0.5rem 1rem; width: auto;">Register Business</button>
                <button id="logoutBtn" class="hidden">Logout</button>
            </div>
        </nav>
    </header>

    <main id="publicView">
        <section>
            <h1 style="font-size: 3rem; color: var(--dark); text-align: center;">Find & Support Local.</h1>
            <div id="searchResults">
                <p style="text-align: center; grid-column: 1/-1; color: #888;">Enter a category above to find local businesses.</p>
            </div>
        </section>
    </main>

    <main id="dashboardView" class="hidden">
        <section>
            <div style="display:flex; justify-content: space-between; align-items: center;">
                <h1 id="welcomeUser">Dashboard</h1>
                <span class="status-badge">‚óè Real-time Sync Active</span>
            </div>

            <div class="dash-grid">
                <div class="side-col">
                    <div class="stat-card">
                        <small>Active Leads</small>
                        <h2 id="leadCount" style="font-size: 3rem; color: var(--primary);">0</h2>
                        <p style="color: #27ae60; font-size: 0.8rem;">Recent inquiries</p>
                    </div>
                    <div class="info-card">
                        <h4 style="margin-bottom:10px">Profile Data</h4>
                        <p><strong>Category:</strong> <span id="dashCat">...</span></p>
                        <p><strong>Owner:</strong> <span id="dashEmail">...</span></p>
                    </div>
                </div>

                <div class="main-col">
                    <div class="lead-card">
                        <h3 style="margin-bottom: 1rem;">Customer Leads (Real-time)</h3>
                        <div id="leadsList">
                            <p style="color:#aaa">No messages yet. When customers find you, their messages will appear here.</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <div id="regModal" class="modal">
        <div class="modal-content">
            <h2>Business Registration</h2>
            <input type="text" id="regName" placeholder="Business Name">
            <input type="text" id="regCat" placeholder="Category (plumbing, food, etc)">
            <input type="email" id="regEmail" placeholder="Email Address">
            <input type="password" id="regPass" placeholder="Password">
            <button id="submitReg" class="btn-main">Create Dashboard</button>
            <button onclick="document.getElementById('regModal').style.display='none'" style="background:none; border:none; width:100%; margin-top:10px; cursor:pointer; color:#999;">Cancel</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, where, getDocs, onSnapshot, serverTimestamp, orderBy } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";

        // Your specific config
        const firebaseConfig = {
            apiKey: "AIzaSyAojYRIH8FJL5B8yg1b3qxsc29vB3vLC-8",
            authDomain: "allbusiness-596cc.firebaseapp.com",
            projectId: "allbusiness-596cc",
            storageBucket: "allbusiness-596cc.firebasestorage.app",
            messagingSenderId: "665302840524",
            appId: "1:665302840524:web:e9c1078e14bc0de6a87e69",
            measurementId: "G-EMZFX7CE8V"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- AUTH TRACKING ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                toggleUI('dashboard');
                initDashboard(user.uid);
            } else {
                toggleUI('public');
            }
        });

        function toggleUI(mode) {
            document.getElementById('publicView').style.display = (mode === 'dashboard') ? 'none' : 'block';
            document.getElementById('dashboardView').style.display = (mode === 'dashboard') ? 'block' : 'none';
            document.getElementById('regBtn').classList.toggle('hidden', mode === 'dashboard');
            document.getElementById('logoutBtn').classList.toggle('hidden', mode === 'public');
            document.getElementById('publicNav').classList.toggle('hidden', mode === 'dashboard');
        }

        // --- DASHBOARD REAL-TIME SYNC ---
        function initDashboard(uid) {
            // Sync Profile Info
            const qBiz = query(collection(db, "businesses"), where("uid", "==", uid));
            onSnapshot(qBiz, (snap) => {
                snap.forEach(doc => {
                    const d = doc.data();
                    document.getElementById('welcomeUser').textContent = d.name;
                    document.getElementById('dashCat').textContent = d.category;
                    document.getElementById('dashEmail').textContent = d.email;
                });
            });

            // Sync Leads (Messages)
            const qLeads = query(collection(db, "leads"), where("businessUid", "==", uid), orderBy("createdAt", "desc"));
            onSnapshot(qLeads, (snap) => {
                const list = document.getElementById('leadsList');
                const count = document.getElementById('leadCount');
                list.innerHTML = '';
                count.textContent = snap.size;

                if(snap.empty) list.innerHTML = '<p style="color:#aaa">No messages yet.</p>';

                snap.forEach(doc => {
                    const lead = doc.data();
                    list.innerHTML += `
                        <div class="lead-item">
                            <strong>New Inquiry</strong><br>
                            <small>${lead.createdAt?.toDate().toLocaleString() || 'Just now'}</small>
                            <p style="margin-top:5px; color:#555">A customer is interested in your <b>${lead.category}</b> services!</p>
                        </div>
                    `;
                });
            });
        }

        // --- SEARCH & SEND LEAD ---
        window.searchBusinesses = async () => {
            const term = document.getElementById('searchInput').value.toLowerCase();
            const resultsDiv = document.getElementById('searchResults');
            resultsDiv.innerHTML = '<p style="text-align:center; grid-column:1/-1;">Searching...</p>';

            const q = query(collection(db, "businesses"), where("category", "==", term));
            const snap = await getDocs(q);
            
            resultsDiv.innerHTML = '';
            if(snap.empty) resultsDiv.innerHTML = '<p style="text-align:center; grid-column:1/-1;">No results found.</p>';
            
            snap.forEach(doc => {
                const d = doc.data();
                const card = document.createElement('div');
                card.className = 'biz-card';
                card.innerHTML = `
                    <h3 style="color:var(--primary)">${d.name}</h3>
                    <p style="text-transform: capitalize;">${d.category}</p>
                    <button class="btn-main" style="margin-top:15px; font-size:0.8rem;">Send Inquiry</button>
                `;
                // Add event to button to send a lead
                card.querySelector('button').onclick = () => sendLead(d.uid, d.category);
                resultsDiv.appendChild(card);
            });
        };

        async function sendLead(bizUid, cat) {
            try {
                await addDoc(collection(db, "leads"), {
                    businessUid: bizUid,
                    category: cat,
                    createdAt: serverTimestamp()
                });
                alert("Message sent to business! (Owner will see this in real-time)");
            } catch (e) { console.error(e); }
        }

        // --- REGISTRATION ---
        document.getElementById('submitReg').onclick = async () => {
            const name = document.getElementById('regName').value;
            const cat = document.getElementById('regCat').value.toLowerCase();
            const email = document.getElementById('regEmail').value;
            const pass = document.getElementById('regPass').value;

            try {
                const userCred = await createUserWithEmailAndPassword(auth, email, pass);
                await addDoc(collection(db, "businesses"), {
                    name, category: cat, email, uid: userCred.user.uid, createdAt: serverTimestamp()
                });
                document.getElementById('regModal').style.display = 'none';
            } catch (err) { alert(err.message); }
        };

        document.getElementById('regBtn').onclick = () => document.getElementById('regModal').style.display = 'flex';
        document.getElementById('logoutBtn').onclick = () => signOut(auth);
    </script>
</body>
</html>
