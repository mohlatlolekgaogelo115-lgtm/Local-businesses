<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>AllBusiness - Business Dashboard (Realtime DB)</title>

  <!-- Firebase Modular SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
    import { 
      getAuth, 
      onAuthStateChanged, 
      signOut 
    } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";

    import { 
      getDatabase,
      ref,
      get,
      query as rtdbQuery,
      orderByChild,
      limitToLast,
      equalTo,
      onValue,
      off
    } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js";

    // Your Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyAojYRIH8FJL5B8yg1b3qxsc29vB3vLC-8",
      authDomain: "allbusiness-596cc.firebaseapp.com",
      databaseURL: "https://allbusiness-596cc-default-rtdb.firebaseio.com", // ← IMPORTANT! Add your real DB URL
      projectId: "allbusiness-596cc",
      storageBucket: "allbusiness-596cc.firebasestorage.app",
      messagingSenderId: "665302840524",
      appId: "1:665302840524:web:e9c1078e14bc0de6a87e69",
      measurementId: "G-EMZFX7CE8V"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    // ────────────────────────────────────────────────
    // Global state & listeners cleanup
    // ────────────────────────────────────────────────
    let currentBusiness = null;
    let ordersListenerRef = null;

    // ────────────────────────────────────────────────
    // DOM Elements
    // ────────────────────────────────────────────────
    const els = {
      loading: document.getElementById('loading-screen'),
      authRequired: document.getElementById('auth-required'),
      dashboard: document.getElementById('dashboard'),
      businessName: document.getElementById('business-name'),
      statsCards: document.querySelector('.stats-cards'),
      recentOrdersBody: document.getElementById('recent-orders'),
      logoutBtn: document.getElementById('logout-btn')
    };

    // ────────────────────────────────────────────────
    // Auth State Listener
    // ────────────────────────────────────────────────
    onAuthStateChanged(auth, async (user) => {
      els.loading.style.display = 'none';

      if (!user) {
        els.authRequired.style.display = 'flex';
        els.dashboard.style.display = 'none';
        cleanupListeners();
        return;
      }

      try {
        const businessRef = ref(db, `businesses/${user.uid}`);
        const snapshot = await get(businessRef);

        if (!snapshot.exists()) {
          showError("Business profile not found. Please register first.");
          els.authRequired.innerHTML = `
            <h2>No business profile</h2>
            <p>Please complete registration first.</p>
            <a href="/register.html" class="btn">Register Business</a>
          `;
          els.authRequired.style.display = 'flex';
          return;
        }

        currentBusiness = { id: user.uid, ...snapshot.val() };
        renderDashboard();
      } catch (err) {
        console.error("Error loading business:", err);
        showError("Failed to load your business data.");
      }
    });

    // ────────────────────────────────────────────────
    // Render Dashboard + Real-time Orders
    // ────────────────────────────────────────────────
    function renderDashboard() {
      els.authRequired.style.display = 'none';
      els.dashboard.style.display = 'block';

      els.businessName.textContent = currentBusiness.name || currentBusiness.businessName || "Your Business";

      // Quick stats (placeholder - in real app use aggregated node or Cloud Function)
      updateStatsPlaceholder();

      // Real-time recent orders (last 8)
      loadAndListenRecentOrders();
    }

    function updateStatsPlaceholder() {
      // In production → read from /businessStats/{uid} maintained by Cloud Functions
      const fake = {
        todaySales: "R18,920",
        newCustomers: 12,
        pendingOrders: 7,
        rating: "4.8"
      };

      els.statsCards.innerHTML = `
        <div class="stat-card"><h3>Today's Sales</h3><p class="value">${fake.todaySales}</p></div>
        <div class="stat-card highlight"><h3>New Customers</h3><p class="value">${fake.newCustomers}</p></div>
        <div class="stat-card"><h3>Pending Orders</h3><p class="value">${fake.pendingOrders}</p></div>
        <div class="stat-card"><h3>Rating</h3><p class="value">${fake.rating} ★</p></div>
      `;
    }

    function loadAndListenRecentOrders() {
      const ordersRef = ref(db, 'orders');
      const recentQuery = rtdbQuery(
        ordersRef,
        orderByChild('createdAt'),
        limitToLast(8),
        equalTo(currentBusiness.id, 'businessId') // ← filter by business
      );

      // Clean up previous listener if exists
      if (ordersListenerRef) off(ordersListenerRef);

      ordersListenerRef = onValue(recentQuery, (snapshot) => {
        const tbody = els.recentOrdersBody;
        tbody.innerHTML = '';

        if (!snapshot.exists()) {
          tbody.innerHTML = '<tr><td colspan="5" class="empty">No recent orders yet...</td></tr>';
          return;
        }

        const orders = [];
        snapshot.forEach(child => {
          orders.push({ id: child.key, ...child.val() });
        });

        // Sort descending by timestamp (since limitToLast gives oldest→newest)
        orders.sort((a,b) => (b.createdAt || 0) - (a.createdAt || 0));

        orders.forEach(order => {
          const date = order.createdAt 
            ? new Date(order.createdAt).toLocaleDateString('en-ZA')
            : '—';

          const row = document.createElement('tr');
          row.innerHTML = `
            <td>#${order.orderNumber || order.id.slice(0,8)}</td>
            <td>${order.customerName || 'Guest'}</td>
            <td>R${(order.total || 0).toLocaleString()}</td>
            <td><span class="status ${order.status?.toLowerCase() || 'pending'}">
              ${order.status || 'Pending'}
            </span></td>
            <td>${date}</td>
          `;
          tbody.appendChild(row);
        });
      }, (err) => {
        console.error("Orders listener error:", err);
        els.recentOrdersBody.innerHTML = '<tr><td colspan="5">Error loading orders</td></tr>';
      });
    }

    function cleanupListeners() {
      if (ordersListenerRef) {
        off(ordersListenerRef);
        ordersListenerRef = null;
      }
    }

    function showError(msg) {
      const el = document.createElement('div');
      el.className = 'error-message';
      el.textContent = msg;
      document.body.prepend(el);
      setTimeout(() => el.remove(), 6500);
    }

    // Logout
    els.logoutBtn?.addEventListener('click', async () => {
      try {
        cleanupListeners();
        await signOut(auth);
        window.location.href = "/";
      } catch (err) {
        console.error("Logout failed:", err);
      }
    });
  </script>

  <style>
    :root {
      --primary: #0066ff;
      --primary-dark: #004dcc;
      --success: #00c853;
      --warning: #ffab00;
      --danger: #d50000;
      --gray-100: #f8f9fc;
      --gray-700: #5a5c69;
    }

    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      font-family: 'Segoe UI', system-ui, sans-serif;
      background: var(--gray-100);
      color: #333;
      min-height: 100vh;
    }

    .container { max-width: 1400px; margin: 0 auto; padding: 1.5rem; }

    header {
      background: white;
      box-shadow: 0 2px 12px rgba(0,0,0,0.08);
      padding: 1rem 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .logo { font-weight: bold; font-size: 1.6rem; color: var(--primary); }

    .welcome { font-size: 1.1rem; color: var(--gray-700); }

    main { padding: 2rem 0; }

    h1 { color: #222; margin-bottom: 1.5rem; }

    .stats-cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 1.5rem;
      margin: 2rem 0;
    }

    .stat-card {
      background: white;
      padding: 1.5rem;
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.06);
      transition: transform 0.2s;
    }

    .stat-card:hover { transform: translateY(-5px); }

    .stat-card h3 { color: var(--gray-700); margin-bottom: 0.5rem; font-size: 0.95rem; }
    .value { font-size: 2.1rem; font-weight: 700; }

    .highlight .value { color: var(--primary); }

    .recent-activity {
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.06);
      padding: 1.5rem;
      overflow-x: auto;
    }

    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 1rem; text-align: left; border-bottom: 1px solid #eee; }
    th { color: var(--gray-700); font-weight: 600; }

    .status {
      padding: 0.35rem 0.9rem;
      border-radius: 30px;
      font-size: 0.85rem;
      font-weight: 600;
    }

    .status.pending    { background:#fff3cd; color:#856404; }
    .status.processing { background:#cce5ff; color:#004085; }
    .status.completed  { background:#d4edda; color:#155724; }
    .status.cancelled  { background:#f8d7da; color:#721c24; }

    .empty { text-align:center; padding:3rem; color:#777; font-style:italic; }

    .auth-screen, .loading-screen {
      min-height: 80vh;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      text-align: center;
      gap: 1.5rem;
    }

    .btn {
      padding: 0.9rem 1.8rem;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 8px;
      text-decoration: none;
      font-weight: 600;
    }

    .btn:hover { background: var(--primary-dark); }

    .error-message {
      position: fixed;
      top: 1.5rem;
      left: 50%;
      transform: translateX(-50%);
      background: #f44336;
      color: white;
      padding: 1rem 2rem;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      z-index: 1000;
    }

    #logout-btn {
      margin-left: 1rem;
      padding: 0.6rem 1.3rem;
      background: #f44336;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }
  </style>
</head>
<body>

  <div id="loading-screen" class="loading-screen auth-screen">
    <h2>Loading dashboard...</h2>
  </div>

  <div id="auth-required" class="auth-screen" style="display:none;">
    <h1>Please sign in</h1>
    <p>You need to be logged in as a registered business.</p>
    <a href="/login.html" class="btn">Sign In</a>
  </div>

  <div id="dashboard" style="display:none;">
    <header>
      <div class="logo">AllBusiness</div>
      <div class="welcome">
        Welcome back, <span id="business-name">Business</span>!
        <button id="logout-btn">Logout</button>
      </div>
    </header>

    <div class="container">
      <h1>Business Dashboard</h1>

      <div class="stats-cards"></div>

      <div class="recent-activity">
        <h2>Recent Orders • Live Updates</h2>
        <table>
          <thead>
            <tr>
              <th>Order</th>
              <th>Customer</th>
              <th>Amount</th>
              <th>Status</th>
              <th>Date</th>
            </tr>
          </thead>
          <tbody id="recent-orders">
            <tr><td colspan="5">Loading real-time orders...</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

</body>
</html>
